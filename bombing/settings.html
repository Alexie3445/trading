<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Wefunds Ltd</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>
<body>
    <!-- Navigation (same as dashboard) -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="logo">
                <span>Wefunds Ltd</span>
            </a>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="profile.html">Profile</a>
                <a href="settings.html" class="nav-link active">Settings</a>
                <div class="user-menu">
                    <div class="balance-display" id="balanceDisplay">
                        <span class="loader" style="width: 16px; height: 16px;"></span>
                    </div>
                    <button onclick="authManager.logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Settings Content -->
    <div class="container" style="padding: 40px 20px;">
        <div style="max-width: 600px; margin: 0 auto;">
            <h1 style="margin-bottom: 30px;">Settings</h1>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Security Settings</h3>
                <div class="form-group">
                    <label class="form-label">Change Password</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="Current Password">
                </div>
                <div class="form-group">
                    <input type="password" id="newPassword" class="form-control" placeholder="New Password">
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm New Password">
                </div>
                <button onclick="changePassword()" class="btn btn-primary">Update Password</button>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Notification Preferences</h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="emailNotifications" checked>
                        <span>Email notifications</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="tradeNotifications" checked>
                        <span>Trade notifications</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="priceAlerts">
                        <span>Price alerts</span>
                    </label>
                </div>
                <button onclick="saveNotifications()" class="btn btn-primary" style="margin-top: 20px;">
                    Save Preferences
                </button>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Trading Preferences</h3>
                <div class="form-group">
                    <label class="form-label">Default Leverage</label>
                    <select id="defaultLeverage" class="form-control">
                        <option value="1">1x</option>
                        <option value="5" selected>5x</option>
                        <option value="10">10x</option>
                        <option value="20">20x</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Default Order Type</label>
                    <select id="defaultOrderType" class="form-control">
                        <option value="market">Market Order</option>
                        <option value="limit">Limit Order</option>
                    </select>
                </div>
                <button onclick="saveTradingPreferences()" class="btn btn-primary">
                    Save Preferences
                </button>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 20px; color: var(--accent-red);">Danger Zone</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    These actions are irreversible. Please proceed with caution.
                </p>
                <button onclick="exportData()" class="btn btn-secondary" style="margin-bottom: 10px;">
                    Export Account Data
                </button>
                <button onclick="deleteAccount()" class="btn btn-danger">
                    Delete Account
                </button>
            </div>
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all password fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            const user = auth.currentUser;
            if (!user) return;

            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email, 
                    currentPassword
                );
                
                await user.reauthenticateWithCredential(credential);
                
                // Update password
                await user.updatePassword(newPassword);
                
                alert('Password updated successfully');
                
                // Clear fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
            } catch (error) {
                console.error('Password change error:', error);
                alert('Failed to change password. Please check your current password.');
            }
        }

        async function saveNotifications() {
            const user = auth.currentUser;
            if (!user) return;

            const notifications = {
                email: document.getElementById('emailNotifications').checked,
                trades: document.getElementById('tradeNotifications').checked,
                priceAlerts: document.getElementById('priceAlerts').checked
            };

            try {
                await db.collection('users').doc(user.uid).update({
                    notifications: notifications,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Notification preferences saved');
            } catch (error) {
                console.error('Error saving notifications:', error);
                alert('Failed to save preferences');
            }
        }

        async function saveTradingPreferences() {
            const user = auth.currentUser;
            if (!user) return;

            const preferences = {
                defaultLeverage: parseInt(document.getElementById('defaultLeverage').value),
                defaultOrderType: document.getElementById('defaultOrderType').value
            };

            try {
                await db.collection('users').doc(user.uid).update({
                    tradingPreferences: preferences,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Trading preferences saved');
            } catch (error) {
                console.error('Error saving preferences:', error);
                alert('Failed to save preferences');
            }
        }

        async function exportData() {
            if (!confirm('Export your account data? This may take a moment.')) return;

            const user = auth.currentUser;
            if (!user) return;

            try {
                // In a real application, you would generate a comprehensive report
                // For now, we'll just show an alert
                alert('Export feature coming soon. Contact support for data export.');
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export data');
            }
        }

        async function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
            
            if (!confirm('FINAL WARNING: All your data will be permanently deleted. This includes your balance, trades, and personal information.')) return;

            const user = auth.currentUser;
            if (!user) return;

            try {
                // Delete user data from Firestore
                await db.collection('users').doc(user.uid).delete();
                
                // Delete user from Firebase Auth
                await user.delete();
                
                alert('Account deleted successfully. Redirecting to home page.');
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Account deletion error:', error);
                alert('Failed to delete account. Please contact support.');
            }
        }

        // Load saved settings
        document.addEventListener('DOMContentLoaded', async () => {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    
                    // Load notification preferences
                    if (data.notifications) {
                        document.getElementById('emailNotifications').checked = data.notifications.email || false;
                        document.getElementById('tradeNotifications').checked = data.notifications.trades || false;
                        document.getElementById('priceAlerts').checked = data.notifications.priceAlerts || false;
                    }
                    
                    // Load trading preferences
                    if (data.tradingPreferences) {
                        document.getElementById('defaultLeverage').value = data.tradingPreferences.defaultLeverage || 5;
                        document.getElementById('defaultOrderType').value = data.tradingPreferences.defaultOrderType || 'market';
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        });
    </script>
</body>
</html>